# Design: flow:decompose — диалоговая декомпозиция задач

## Проблема

`flow:after-design` совмещает две обязанности: привязку дизайн-документа и создание подзадач. Парсинг подзадач из документа срабатывает ложно (ищет во всех секциях с перечислениями), а для атомарных задач шаг декомпозиции раздражает.

## Решение

Разделить на два скилла:

- **`flow:after-design`** (`linking-design`) — привязка дизайн-документа. Простая операция, аналог `flow:after-plan`.
- **`/flow:decompose`** (`decomposing-task`) — диалоговая декомпозиция задачи на подзадачи на основе дизайн-документа. Отдельный процесс, запускается пользователем когда нужен.

## Новый скилл: decomposing-task

### Вход

- Текущая in_progress задача (из контекста разговора или через `bd list`)
- Дизайн-документ (из ссылки `Design:` в описании задачи, или спросить путь)

### Процесс

#### Шаг 1 — Найти задачу и дизайн

1. Проверить контекст — если задача выбрана (после `flow:start`), использовать её.
2. Если нет — `bd list --status=in_progress`, найти leaf-задачу.
3. Прочитать описание задачи, найти строку `Design: docs/plans/...`.
4. Если ссылки нет — спросить путь к документу.
5. Прочитать дизайн-документ.

#### Шаг 2 — Обсуждение подхода к декомпозиции

Скилл читает дизайн и предлагает 2-3 варианта разбивки. Каждый вариант — принцип разбиения + пример первых 2-3 подзадач.

Примеры подходов:
- По компонентам/модулям
- По этапам реализации
- По слоям архитектуры (данные → логика → UI)
- По пользовательским сценариям

Пользователь выбирает подход или предлагает свой.

#### Шаг 3 — Формирование списка подзадач

На основе выбранного подхода скилл формирует полный список подзадач. Для каждой определяет:

| Атрибут | Как определяется |
|---------|-----------------|
| Заголовок | По содержанию (обязательно) |
| Описание | 1-3 предложения (опционально) |
| Тип | По содержанию (см. таблицу ниже) |
| Приоритет | Наследуется от родителя |
| Лейблы | От родителя + по содержанию (см. правила ниже) |

**Определение типа по содержанию:**

| Содержание | Тип |
|---|---|
| Исправление бага, фикс | bug |
| Новая функциональность, добавление возможности | feature |
| Техработы (CI/CD, линтеры, инфра), рефакторинг | chore |
| Документация, всё остальное | task |

**Определение лейблов:**

Всегда копируются лейблы родителя. Дополнительные лейблы добавляются по содержанию:
- chore/task: `#ci`, `#infra`, `#docs` и т.д.
- feature/bug: по подсистемам (`#api`, `#cli`, `#config` и т.д.)

Пользователь корректирует: добавить, убрать, переименовать, объединить подзадачи. На каждой итерации скилл выводит полный список подзадач с текущими атрибутами — пользователь всегда видит целую картину, а не только изменения. Итерируем пока пользователь не одобрит.

**Всё в превью — рекомендация. Финальное решение о задачах остаётся за пользователем.**

#### Шаг 4 — Мердж с существующими подзадачами

`bd show {parent-id}` — получить текущие подзадачи. Для каждой новой:

| Совпадение | Действие |
|---|---|
| Exact match (заголовок идентичен) | Пропустить |
| >80% similarity | Спросить пользователя |
| Нет совпадений | Создать |

**Формат превью:**

```
Подзадачи для создания:
1. [F] Название фичи | P3 | #statuskit #cli — описание
2. [C] Рефакторинг модуля | P3 | #statuskit #infra — описание
3. [B] Фикс валидации | P3 | #statuskit #config — описание

Пропущены (уже существуют):
- claude-tools-xxx: Существующая задача (exact match)

Что изменить, или создать 3 подзадачи?
```

#### Шаг 5 — Создание и фиксация

1. `bd create --title="..." --description="..." --type=... --priority=P3 --parent={parent-id} --label=...` для каждой новой подзадачи.
2. Дописать секцию "## Decomposition" в конец дизайн-документа:

```markdown
## Декомпозиция

1. **Название фичи** (claude-tools-xxx) — описание
2. **Рефакторинг модуля** (claude-tools-yyy) — описание
3. **Фикс валидации** (claude-tools-zzz) — описание
```

3. `git add docs/plans/...` + `git commit` дизайн-документа.
4. `bd sync`.

### Что скилл НЕ делает

- Не привязывает дизайн-документ (это `flow:after-design`)
- Не создаёт ветки (это `flow:start`)
- Не коммитит код
- Не меняет статус задачи

## Изменения в flow:after-design

Скилл `linking-design` упрощается до привязки ссылки:

| Шаг | Действие |
|-----|----------|
| 1 | Найти in_progress задачу (из контекста или `bd list`) |
| 2 | Найти дизайн-документ (`ls -t docs/plans/*.md \| head -1`) |
| 3 | Привязать: `bd update {id} --description="...\n\nDesign: docs/plans/..."` |
| 4 | `git add docs/plans/...` + `git commit` дизайн-документа |
| 5 | `bd sync` |
| 6 | Предложить: "Хочешь декомпозировать задачу? → `/flow:decompose`" |

Становится зеркалом `flow:after-plan` — простая привязка, ничего больше.

## Файловая структура

```
plugins/flow/
├── commands/
│   ├── after-design.md          # Обновить (убрать упоминание подзадач)
│   └── decompose.md             # Новый — вызов decomposing-task
├── skills/
│   ├── linking-design/
│   │   └── SKILL.md             # Упростить (шаги 3-7 удалить)
│   └── decomposing-task/
│       └── SKILL.md             # Новый скилл
└── .claude-plugin/
    └── plugin.json              # Зарегистрировать новый скилл
```
