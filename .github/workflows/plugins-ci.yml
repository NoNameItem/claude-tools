name: Plugins CI

on:
  pull_request:
    paths: ['plugins/**']
  push:
    branches: [main]
    paths: ['plugins/**']

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      plugin: ${{ steps.detect.outputs.plugin }}
      plugin_path: ${{ steps.detect.outputs.plugin_path }}
      has_plugins: ${{ steps.detect.outputs.has_plugins }}
      has_python: ${{ steps.check-python.outputs.has_python }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Detect changes
        id: detect
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            REF="origin/${{ github.base_ref }}..HEAD"
          else
            REF="HEAD~1..HEAD"
          fi
          OUTPUT=$(python -m scripts.detect_changes --ref "$REF")
          echo "Output: $OUTPUT"
          PLUGIN=$(echo "$OUTPUT" | jq -r '.plugins[0] // empty')
          echo "plugin=$PLUGIN" >> $GITHUB_OUTPUT
          echo "plugin_path=plugins/$PLUGIN" >> $GITHUB_OUTPUT
          echo "has_plugins=$(echo "$OUTPUT" | jq -r '.has_plugins')" >> $GITHUB_OUTPUT
        working-directory: .github

      - name: Check for Python files
        id: check-python
        if: steps.detect.outputs.has_plugins == 'true'
        run: |
          if find ${{ steps.detect.outputs.plugin_path }} -name "*.py" 2>/dev/null | grep -q .; then
            echo "has_python=true" >> $GITHUB_OUTPUT
          else
            echo "has_python=false" >> $GITHUB_OUTPUT
          fi

  validate-structure:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_plugins == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate plugin structure
        run: |
          python -m scripts.validate_plugin ${{ needs.detect-changes.outputs.plugin_path }}
        working-directory: .github

  lint-scripts:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_plugins == 'true' && needs.detect-changes.outputs.has_python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Install ruff
        run: uv tool install ruff

      - name: Ruff check
        run: ruff check --config pyproject.toml ${{ needs.detect-changes.outputs.plugin_path }}

      - name: Ruff format check
        run: ruff format --config pyproject.toml --check ${{ needs.detect-changes.outputs.plugin_path }}
