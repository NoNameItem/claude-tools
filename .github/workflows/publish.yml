# .github/workflows/publish.yml
name: Publish

on:
  release:
    types: [published]

permissions:
  contents: read
  id-token: write  # For PyPI Trusted Publisher
  actions: read    # For fetching failed jobs in notifications

jobs:
  notify-start:
    name: Notify Start
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/telegram-notify
        with:
          status: started
          event-type: release
          title: ${{ github.event.release.tag_name }}
          event-url: ${{ github.event.release.html_url }}
          message: "Publishing..."
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}

  resolve:
    name: Resolve publish targets
    runs-on: ubuntu-latest
    outputs:
      project-name: ${{ steps.resolve.outputs.project-name }}
      project-path: ${{ steps.resolve.outputs.project-path }}
      project-type: ${{ steps.resolve.outputs.project-type }}
      version: ${{ steps.resolve.outputs.version }}
      publish-targets: ${{ steps.resolve.outputs.publish-targets }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Resolve publish targets
        id: resolve
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          RESULT=$(python .github/scripts/resolve_publish.py "$RELEASE_TAG")
          echo "Result: $RESULT"

          echo "project-name=$(echo "$RESULT" | jq -r '.project_name')" >> "$GITHUB_OUTPUT"
          echo "project-path=$(echo "$RESULT" | jq -r '.project_path')" >> "$GITHUB_OUTPUT"
          echo "project-type=$(echo "$RESULT" | jq -r '.project_type')" >> "$GITHUB_OUTPUT"
          echo "version=$(echo "$RESULT" | jq -r '.version')" >> "$GITHUB_OUTPUT"
          echo "publish-targets=$(echo "$RESULT" | jq -c '.publish_targets')" >> "$GITHUB_OUTPUT"

  publish-pypi:
    name: Publish to PyPI
    needs: [resolve]
    if: contains(fromJson(needs.resolve.outputs.publish-targets), 'pypi')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: pypi
      url: https://pypi.org/project/${{ needs.resolve.outputs.project-name }}/${{ needs.resolve.outputs.version }}/
    outputs:
      summary-message: ${{ steps.summary.outputs.message }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup uv
        uses: astral-sh/setup-uv@v7

      - name: Read package metadata
        id: metadata
        working-directory: ${{ needs.resolve.outputs.project-path }}
        run: |
          # Extract metadata from pyproject.toml
          python -c "
          import tomllib
          import json
          import os

          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)

          # PyPI package name
          pypi_name = data['project']['name']

          # Python module name (from hatch packages or derive from pypi name)
          packages = data.get('tool', {}).get('hatch', {}).get('build', {}).get('targets', {}).get('wheel', {}).get('packages', [])
          if packages:
              # Extract module name from 'src/statuskit' -> 'statuskit'
              module_name = os.path.basename(packages[0])
          else:
              # Fallback: convert pypi name to module name
              module_name = pypi_name.replace('-', '_')

          # CLI scripts
          scripts = list(data.get('project', {}).get('scripts', {}).keys())

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'pypi-name={pypi_name}\n')
              f.write(f'module-name={module_name}\n')
              f.write(f'scripts={json.dumps(scripts)}\n')
          "

      - name: Build package
        working-directory: ${{ needs.resolve.outputs.project-path }}
        run: uv build --out-dir dist

      - name: Smoke test
        working-directory: ${{ needs.resolve.outputs.project-path }}
        env:
          PYPI_NAME: ${{ steps.metadata.outputs.pypi-name }}
          MODULE_NAME: ${{ steps.metadata.outputs.module-name }}
          EXPECTED_VERSION: ${{ needs.resolve.outputs.version }}
          CLI_SCRIPTS: ${{ steps.metadata.outputs.scripts }}
        run: |
          set -euo pipefail

          echo "=== Creating clean venv ==="
          python -m venv .smoke-test-venv
          source .smoke-test-venv/bin/activate

          echo "=== Installing wheel ==="
          WHEEL=$(ls dist/*.whl)
          pip install "$WHEEL"

          echo "=== Checking import ==="
          python -c "import $MODULE_NAME"

          echo "=== Checking version ==="
          INSTALLED_VERSION=$(python -c "
          from importlib.metadata import version
          print(version('$PYPI_NAME'))
          ")

          if [ "$INSTALLED_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "ERROR: Version mismatch!"
            echo "  Expected: $EXPECTED_VERSION"
            echo "  Installed: $INSTALLED_VERSION"
            exit 1
          fi
          echo "Version OK: $INSTALLED_VERSION"

          echo "=== Checking CLI commands ==="
          for cmd in $(echo "$CLI_SCRIPTS" | python -c "import sys, json; print(' '.join(json.load(sys.stdin)))"); do
            echo "Testing: $cmd --help"
            $cmd --help > /dev/null
          done

          echo "=== Smoke test passed ==="

      - name: Publish to PyPI
        id: publish
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: ${{ needs.resolve.outputs.project-path }}/dist/

      - name: Generate summary message
        id: summary
        if: always()
        env:
          PYPI_NAME: ${{ steps.metadata.outputs.pypi-name }}
          VERSION: ${{ needs.resolve.outputs.version }}
          PUBLISH_OUTCOME: ${{ steps.publish.outcome }}
        run: |
          if [ "$PUBLISH_OUTCOME" == "success" ]; then
            MESSAGE="Published to https://pypi.org/project/$PYPI_NAME/$VERSION/
          Install: pip install $PYPI_NAME==$VERSION"
          else
            MESSAGE="Publish failed"
          fi
          # Use heredoc for multiline output
          {
            echo "message<<EOF"
            echo "$MESSAGE"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  summary:
    name: Publish Summary
    needs: [resolve, publish-pypi]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      telegram-message: ${{ steps.summary.outputs.telegram-message }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate Summary
        id: summary
        env:
          NEEDS_JSON: ${{ toJson(needs) }}
        run: python .github/scripts/publish_summary.py

  notify-finish:
    name: Notify Finish
    needs: [resolve, publish-pypi, summary]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/telegram-notify
        with:
          status: ${{ (needs.publish-pypi.result == 'success' || needs.publish-pypi.result == 'skipped') && 'success' || 'failure' }}
          event-type: release
          title: "${{ needs.resolve.outputs.project-name }} ${{ needs.resolve.outputs.version }}"
          event-url: ${{ github.event.release.html_url }}
          message: ${{ needs.summary.outputs.telegram-message }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
