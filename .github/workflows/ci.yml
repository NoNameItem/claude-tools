# .github/workflows/ci.yml
name: CI

on:
  pull_request:
    paths:
      - 'packages/**'
      - 'pyproject.toml'
      - 'uv.lock'
  push:
    branches: [master]
    paths:
      - 'packages/**'
      - 'pyproject.toml'
      - 'uv.lock'

jobs:
  validate-pr:
    name: Validate PR
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR title
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: python .github/scripts/validate.py --pr

  validate-push:
    name: Validate commits
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commits
        run: |
          python .github/scripts/validate.py --commits \
            ${{ github.event.before }} \
            ${{ github.sha }}

  detect:
    name: Detect changes
    needs: [validate-pr, validate-push]
    if: |
      always() &&
      (needs.validate-pr.result == 'success' || needs.validate-pr.result == 'skipped') &&
      (needs.validate-push.result == 'success' || needs.validate-push.result == 'skipped')
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.detect.outputs.matrix }}
      all-packages-matrix: ${{ steps.detect.outputs.all_packages_matrix }}
      has-packages: ${{ steps.detect.outputs.has_packages }}
      tooling-changed: ${{ steps.detect.outputs.tooling_changed }}
      changed-files: ${{ steps.detect.outputs.changed_files }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: detect
        run: |
          OUTPUT=$(python .github/scripts/detect_changes.py --ref origin/master..HEAD)
          {
            echo "matrix=$(echo "$OUTPUT" | jq -c '.matrix')"
            echo "all_packages_matrix=$(echo "$OUTPUT" | jq -c '.all_packages_matrix')"
            echo "has_packages=$(echo "$OUTPUT" | jq -r '.has_packages')"
            echo "tooling_changed=$(echo "$OUTPUT" | jq -r '.tooling_changed')"
            echo "changed_files=$(echo "$OUTPUT" | jq -c '.changed_files')"
          } >> "$GITHUB_OUTPUT"

  ci:
    name: CI
    needs: detect
    if: needs.detect.outputs.has-packages == 'true' || needs.detect.outputs.tooling-changed == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ needs.detect.outputs.tooling-changed == 'true' && fromJson(needs.detect.outputs.all-packages-matrix) || fromJson(needs.detect.outputs.matrix) }}
    uses: ./.github/workflows/_reusable-python-ci.yml
    with:
      package: ${{ matrix.package }}
      package-path: ${{ matrix.path }}
      python-versions: ${{ toJson(fromJson(format('["{0}"]', matrix.python))) }}
      changed-files: ${{ toJson(fromJson(needs.detect.outputs.changed-files)[matrix.package] || fromJson('[]')) }}
