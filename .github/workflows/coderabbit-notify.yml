# .github/workflows/coderabbit-notify.yml
name: CodeRabbit Notify

on:
  status

jobs:
  notify:
    name: Notify CodeRabbit Status
    if: github.event.context == 'CodeRabbit'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Find PR for commit
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_SHA: ${{ github.event.sha }}
        run: |
          # Find open PR containing this commit
          PR_DATA=$(gh pr list --state open --json number,title,url,headRefOid \
            --jq ".[] | select(.headRefOid == \"$COMMIT_SHA\")")

          if [ -z "$PR_DATA" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "No open PR found for commit $COMMIT_SHA"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "number=$(echo "$PR_DATA" | jq -r '.number')" >> "$GITHUB_OUTPUT"
          echo "title=$(echo "$PR_DATA" | jq -r '.title')" >> "$GITHUB_OUTPUT"
          echo "url=$(echo "$PR_DATA" | jq -r '.url')" >> "$GITHUB_OUTPUT"

      - uses: ./.github/actions/telegram-notify
        if: steps.pr.outputs.skip != 'true'
        with:
          status: ${{ github.event.state == 'pending' && 'started' || (github.event.state == 'success' && 'success' || 'failure') }}
          event-type: pr
          title: "CodeRabbit | PR #${{ steps.pr.outputs.number }}: ${{ steps.pr.outputs.title }}"
          event-url: ${{ steps.pr.outputs.url }}
          message: ${{ github.event.state == 'pending' && 'Review started' || 'Review completed' }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
